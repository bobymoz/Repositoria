<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JINOCA - O Melhor Diretório de Grupos de WhatsApp e Telegram</title>
    
    <!-- SEO Meta Tags Otimizadas para JINOCA -->
    <meta name="description" content="Encontre e participe dos melhores grupos de WhatsApp e Telegram no JINOCA! O maior diretório de links para grupos de amizade, animes, jogos, vendas e muito mais. Adicione seu grupo grátis!">
    <meta name="keywords" content="jinoca, grupos whatsapp, grupos telegram, link de grupos, grupos de zap, diretório de grupos, grupos de amizade, grupos de jogos, grupos de animes, links de grupos 2025, participar de grupos">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://jinoca.com/" />

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    
    <!-- Font Awesome for Platform Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FFD700', // Dourado
                        'primary-dark': '#E6C200',
                        'background-dark': '#0D0D0D',
                        'surface-dark': '#1A1A1A',
                        'text-dark': '#EAEAEA',
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    boxShadow: { 'gold': '0 0 20px 2px rgba(255, 215, 0, 0.5)', },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        shimmer: { '0%': { backgroundPosition: '-1000px 0' }, '100%': { backgroundPosition: '1000px 0' } }
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'shimmer': 'shimmer 2s infinite linear'
                    }
                },
            },
        };
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: -2; transition: opacity 0.5s ease-in-out; background-size: cover; background-position: center center; }
        #main-background { background-image: url('https://i.imghippo.com/files/hnKZ9316s.jpg'); }
        #add-group-background { background-image: url('https://i.imghippo.com/files/fvo2457NgU.jpg'); opacity: 0; }
        #detail-background { background-image: url('https://i.imghippo.com/files/jGI7728Ls.jpg'); opacity: 0; }
        .bg-overlay::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.75); z-index: -1; }
        .shimmer-bg { background: linear-gradient(to right, #2a2a2a 0%, #3a3a3a 50%, #2a2a2a 100%); background-size: 2000px 100%; animation: shimmer 2s infinite linear; }
        .view-container.hidden { display: none; }
        .star-rating label { color: #4a4a4a; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #FFD700; }
        .star-rating input:checked + label { color: #FFD700; }
    </style>
</head>
<body class="bg-background-dark text-text-dark font-sans">
    
    <div id="main-background" class="background-container bg-overlay"></div>
    <div id="add-group-background" class="background-container bg-overlay"></div>
    <div id="detail-background" class="background-container bg-overlay"></div>

    <div id="app-container">
        <header class="sticky top-0 z-30 bg-surface-dark/50 backdrop-blur-lg border-b border-gray-800">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
                <a href="#home" class="nav-link flex items-center gap-3"><img src="https://i.imghippo.com/files/RNE8811Hk.jpg" alt="Logo JINOCA" class="h-12 w-12 object-cover rounded-full border-2 border-primary"><h1 class="text-2xl font-bold text-white hidden sm:block">JINOCA</h1></a>
                <a href="#add-group" class="nav-link flex items-center gap-2 bg-primary text-black font-bold py-2 px-5 rounded-lg hover:bg-primary-dark transition-all duration-300 transform hover:scale-105"><span class="material-symbols-outlined">add_circle</span><span class="hidden sm:inline">Adicionar Grupo</span></a>
            </nav>
        </header>

        <main id="main-content" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-[calc(100vh-200px)]">
            <div id="home-view" class="view-container hidden animate-fade-in"></div>
            <div id="group-detail-view" class="view-container hidden animate-fade-in"></div>
            <div id="add-group-view" class="view-container hidden animate-fade-in"></div>
        </main>

        <footer class="bg-surface-dark/50 mt-12 border-t border-gray-800">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-gray-400">
                <div class="flex flex-col sm:flex-row justify-between items-center sm:text-left">
                    <p>&copy; 2024 JINOCA. Todos os direitos reservados.</p>
                    <div class="mt-4 sm:mt-0">
                        <p class="mb-2">Precisa de ajuda? Contate o suporte:</p>
                        <a href="https://t.me/Hackermol" target="_blank" rel="noopener" class="text-gray-400 hover:text-primary transition-colors" aria-label="Contato via Telegram"><i class="fa-brands fa-telegram text-3xl"></i></a>
                    </div>
                </div>
                <p class="text-xs mt-6 border-t border-gray-700 pt-4">Ao navegar neste site, você declara que leu e aceita nossos <a href="https://amogalinha.online/termos.html" target="_blank" rel="noopener" class="underline hover:text-primary">termos e condições</a>.</p>
            </div>
        </footer>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 z-[100] flex items-center gap-3 text-white py-3 px-5 rounded-lg shadow-2xl opacity-0 translate-y-10 transition-all duration-300">
        <span id="toast-icon" class="material-symbols-outlined"></span><p id="toast-message"></p>
    </div>
    
    <div id="processing-overlay" class="fixed inset-0 bg-black/80 z-[100] flex-col items-center justify-center hidden">
        <img src="https://www.imagensanimadas.com/data/media/942/anime-imagem-animada-0186.gif" border="0" alt="processando..." />
        <p class="text-white text-xl mt-4 font-bold">Publicando seu grupo...</p>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, deleteDoc, onSnapshot, query, orderBy, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = { apiKey: "AIzaSyD1O6KzJVLh5RshdgPCII9BaJyBZyGc2ho", authDomain: "amogalinha-d393e.firebaseapp.com", databaseURL: "https://amogalinha-d393e-default-rtdb.firebaseio.com", projectId: "amogalinha-d393e", storageBucket: "amogalinha-d393e.appspot.com", messagingSenderId: "741378248192", appId: "1:741378248192:web:7c84327d97391122df92e5" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let isAdmin = false, allGroups = [];
        let currentFilter = { search: '', category: 'Todos' };
        let searchDebounceTimeout;
        const views = { home: document.getElementById('home-view'), detail: document.getElementById('group-detail-view'), add: document.getElementById('add-group-view') };
        const backgrounds = { main: document.getElementById('main-background'), add: document.getElementById('add-group-background'), detail: document.getElementById('detail-background')};
        const toast = { element: document.getElementById('toast'), icon: document.getElementById('toast-icon'), message: document.getElementById('toast-message') };
        const processingOverlay = document.getElementById('processing-overlay');

        const switchView = async (hash) => {
            const [viewName, id] = hash.substring(1).split('/');
            Object.values(views).forEach(v => v.classList.add('hidden'));
            
            const isAddPage = viewName === 'add-group' || viewName === 'edit-group';
            const isDetailPage = viewName === 'group';

            backgrounds.main.style.opacity = !isAddPage && !isDetailPage ? '1' : '0';
            backgrounds.add.style.opacity = isAddPage ? '1' : '0';
            backgrounds.detail.style.opacity = isDetailPage ? '1' : '0';
            
            if (isAddPage) {
                const groupToEdit = viewName === 'edit-group' ? allGroups.find(g => g.id === id) : null;
                renderAddGroupPage(groupToEdit);
                views.add.classList.remove('hidden');
            } else if (isDetailPage && id) {
                views.detail.classList.remove('hidden');
                if (allGroups.length > 0) {
                    const group = allGroups.find(g => g.id === id);
                    if (group) await renderSingleGroupPage(group);
                    else window.location.hash = '#home';
                }
            } else {
                views.home.classList.remove('hidden');
            }
            window.scrollTo(0, 0);
        };
        
        const showToast = (message, icon, isError = false) => {
            toast.message.textContent = message;
            toast.icon.textContent = icon;
            const bgColor = isError ? 'bg-red-600' : 'bg-green-600';
            toast.element.className = toast.element.className.replace(/bg-(red|green)-600/, bgColor);
            toast.element.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.element.classList.add('opacity-0', 'translate-y-10'); }, 4000);
        };
        
        const createSkeletonCard = () => `<div class="bg-surface-dark/50 rounded-xl p-4 space-y-3"><div class="h-40 w-full shimmer-bg rounded-md"></div><div class="h-5 w-3/4 shimmer-bg rounded-md"></div><div class="h-4 w-1/4 shimmer-bg rounded-md"></div></div>`;
        const renderSkeletons = (container, count) => { if(container) container.innerHTML = Array(count).fill(createSkeletonCard()).join(''); };
        
        const renderHomePage = () => {
             views.home.innerHTML = `
                <div class="text-center mb-10">
                    <h2 class="text-4xl md:text-5xl font-extrabold mb-3 text-white">Encontre os Melhores Grupos</h2>
                    <p class="text-lg text-gray-300 max-w-2xl mx-auto">Sua busca por comunidades incríveis de WhatsApp e Telegram termina aqui.</p>
                </div>
                <div class="mb-10 p-4 bg-surface-dark/70 rounded-xl backdrop-blur-sm sticky top-[88px] z-10">
                     <div class="relative">
                          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                          <input type="text" id="search-input" placeholder="Pesquisar por nome, tema ou categoria..." class="w-full bg-background-dark border-gray-700 rounded-lg pl-12 pr-4 py-3 text-white focus:ring-primary focus:border-primary">
                     </div>
                     <div id="category-filters-container" class="flex flex-wrap gap-2 justify-center pt-4"></div>
                </div>
                <div id="search-feedback" class="text-center text-gray-400 hidden my-4"><span class="material-symbols-outlined animate-spin">progress_activity</span><p>Buscando...</p></div>
                <section id="featured-groups" class="mb-12"><h3 class="text-2xl font-bold mb-6 flex items-center gap-2 text-white"><span class="material-symbols-outlined text-primary">hotel_class</span>Destaques do Editor</h3><div id="featured-groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></section>
                <section id="all-groups"><h3 class="text-2xl font-bold mb-6 text-white">Novos Grupos na Comunidade</h3><div id="all-groups-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div></section>
                <div id="no-results" class="text-center text-gray-400 text-lg hidden py-16"><span class="material-symbols-outlined text-6xl text-gray-600 mb-4">search_off</span><p>Nenhum grupo encontrado.<br>Tente uma busca ou filtro diferente.</p></div>`;
            document.getElementById('search-input').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                const feedback = document.getElementById('search-feedback');
                const featuredContainer = document.getElementById('featured-groups-container');
                const allContainer = document.getElementById('all-groups-container');
                clearTimeout(searchDebounceTimeout);
                if (query) {
                    feedback.classList.remove('hidden');
                    renderSkeletons(featuredContainer, 3);
                    renderSkeletons(allContainer, 8);
                } else {
                    feedback.classList.add('hidden');
                }
                searchDebounceTimeout = setTimeout(() => {
                    currentFilter.search = query;
                    filterAndRenderGroups();
                    feedback.classList.add('hidden');
                }, 500);
            });
        };

        const createGroupCardHTML = (group, isFeatured) => {
            const platformIcon = group.platform === 'WhatsApp' ? `<i class="fa-brands fa-whatsapp text-xl text-green-500"></i>` : `<i class="fa-brands fa-telegram text-xl text-cyan-400"></i>`;
            const adminHTML = isAdmin ? `<div class="absolute top-2 right-2 flex gap-2">${adminControls(group.id)}</div>` : '';
            const cardLink = `#group/${group.id}`;
            if (isFeatured) {
                return `<div class="relative bg-surface-dark border-2 border-primary rounded-xl overflow-hidden shadow-gold transition-transform duration-300 hover:-translate-y-2 flex flex-col">
                    <a href="${cardLink}" class="nav-link block h-48"><img src="${group.iconUrl || 'https://placehold.co/600x400/1A1A1A/FFD700?text=Grupo'}" alt="Ícone do grupo ${group.title}" class="h-full w-full object-cover"></a>
                    <div class="p-5 flex-grow flex flex-col">
                        <div class="flex justify-between items-start mb-2"><h4 class="text-lg font-bold text-white mb-1 flex-1 pr-2"><a href="${cardLink}" class="nav-link hover:underline">${group.title}</a></h4><span class="text-xs font-medium bg-primary/20 text-primary px-2 py-1 rounded-full whitespace-nowrap">${group.category}</span></div>
                        <p class="text-sm text-gray-400 mb-4 flex-grow">${group.description}</p>
                        <div class="mt-auto pt-4 border-t border-gray-800 flex items-center justify-between"><a href="${cardLink}" class="nav-link text-sm font-semibold text-primary hover:underline">Ver detalhes</a><a href="${group.link}" target="_blank" rel="noopener noreferrer" class="text-sm font-bold bg-primary text-black px-4 py-2 rounded-lg hover:bg-primary-dark transition-opacity flex items-center gap-2">${platformIcon} Entrar</a></div>
                    </div>${adminHTML}</div>`;
            }
            return `<div class="relative bg-surface-dark border border-gray-800 rounded-xl overflow-hidden transition-all hover:shadow-lg hover:border-gray-700 hover:-translate-y-1 flex flex-col">
                <a href="${cardLink}" class="nav-link block h-40"><img src="${group.iconUrl || 'https://placehold.co/400x300/1A1A1A/CCCCCC?text=Grupo'}" alt="Ícone do grupo ${group.title}" class="h-full w-full object-cover"></a>
                <div class="p-4 flex-grow flex flex-col"><h4 class="font-bold text-md text-white mb-2 truncate"><a href="${cardLink}" class="nav-link hover:underline">${group.title}</a></h4><span class="text-xs font-medium bg-gray-800 text-gray-400 px-2 py-1 rounded-full mb-3 self-start">${group.category}</span><div class="mt-auto pt-3 border-t border-gray-800 flex items-center justify-between"><a href="${cardLink}" class="nav-link text-sm font-semibold text-primary hover:underline">Ver mais</a><a href="${group.link}" target="_blank" rel="noopener noreferrer" class="text-sm font-bold text-gray-300 hover:text-white flex items-center gap-2">${platformIcon} Entrar</a></div></div>
                ${adminHTML}</div>`;
        };

        const renderSingleGroupPage = async (group) => {
            const recommended = allGroups.filter(g => g.id !== group.id && g.category === group.category).slice(0, 4);
            if (recommended.length < 4) {
                recommended.push(...allGroups.filter(g => g.id !== group.id && !recommended.find(rec => rec.id === g.id)).slice(0, 4 - recommended.length));
            }
            views.detail.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <a href="#home" class="nav-link inline-flex items-center gap-2 text-primary hover:underline mb-6"><span class="material-symbols-outlined">arrow_back</span>Voltar para a lista</a>
                    <div class="bg-surface-dark rounded-xl shadow-lg overflow-hidden ${group.featured ? 'border-2 border-primary shadow-gold' : 'border border-gray-800'}">
                        <div class="p-6 sm:p-8"><div class="flex flex-col sm:flex-row gap-6">
                            <img src="${group.iconUrl || 'https://placehold.co/400x400/1A1A1A/FFD700?text=Icon'}" alt="Ícone do grupo ${group.title}" class="w-24 h-24 sm:w-32 sm:h-32 object-cover rounded-xl border-2 border-gray-700 flex-shrink-0 mx-auto sm:mx-0">
                            <div class="flex-grow text-center sm:text-left">
                                ${group.featured ? `<div class="flex items-center justify-center sm:justify-start gap-2 text-primary font-bold mb-2"><span class="material-symbols-outlined">hotel_class</span><span>DESTAQUE</span></div>` : ''}
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 sm:gap-4 mb-2"><h2 class="text-3xl sm:text-4xl font-extrabold text-white">${group.title}</h2><span class="text-sm font-medium bg-primary/20 text-primary px-3 py-1 rounded-full self-center sm:self-start">${group.category}</span></div>
                                <p class="text-base sm:text-lg text-gray-300">${group.description}</p>
                            </div>
                        </div>
                        ${group.featured && group.longDescription ? `<div class="prose prose-invert max-w-none text-gray-300 mt-6 pt-6 border-t border-gray-700">${group.longDescription.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>
                        <div class="px-6 sm:px-8 py-6 bg-gray-900/50"><a href="${group.link}" target="_blank" rel="noopener noreferrer" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-primary text-black font-bold py-3 px-6 rounded-lg hover:bg-primary-dark transition-transform hover:scale-105 text-lg"><span class="material-symbols-outlined">login</span>Entrar no Grupo Agora</a></div>
                    </div>
                    <section class="mt-16 bg-surface-dark/80 p-6 rounded-xl">
                        <h3 class="text-2xl font-bold mb-4 text-white">Avaliações da Comunidade</h3>
                        <div id="avg-rating" class="mb-4 flex items-center text-lg"></div>
                        <div id="reviews-container" class="space-y-4 mb-6 max-h-96 overflow-y-auto pr-2"></div>
                        <form id="review-form" class="space-y-3 pt-6 border-t border-gray-700">
                            <h4 class="font-bold text-lg">Deixe sua avaliação:</h4>
                            <div class="star-rating flex flex-row-reverse justify-end">
                                <input type="radio" id="star5" name="rating" value="5" class="hidden"/><label for="star5" class="text-4xl">★</label>
                                <input type="radio" id="star4" name="rating" value="4" class="hidden"/><label for="star4" class="text-4xl">★</label>
                                <input type="radio" id="star3" name="rating" value="3" class="hidden"/><label for="star3" class="text-4xl">★</label>
                                <input type="radio" id="star2" name="rating" value="2" class="hidden"/><label for="star2" class="text-4xl">★</label>
                                <input type="radio" id="star1" name="rating" value="1" class="hidden" required/><label for="star1" class="text-4xl">★</label>
                            </div>
                            <textarea id="comment" placeholder="Escreva seu comentário (opcional)..." class="w-full bg-background-dark border-gray-700 rounded-lg focus:ring-primary focus:border-primary" rows="3"></textarea>
                            <button type="submit" class="bg-primary text-black font-bold py-2 px-5 rounded-lg hover:bg-primary-dark transition-colors">Enviar Avaliação</button>
                        </form>
                    </section>
                    <section class="mt-16"><h3 class="text-3xl font-bold mb-8 text-white text-center">Recomendados</h3><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${recommended.map(g => createGroupCardHTML(g, false)).join('')}</div></section>
                </div>`;
            
            const reviewsQuery = query(collection(db, `groups/${group.id}/reviews`), orderBy('timestamp', 'desc'));
            onSnapshot(reviewsQuery, (snapshot) => {
                const reviews = snapshot.docs.map(doc => doc.data());
                const reviewsContainer = document.getElementById('reviews-container');
                const avgRatingEl = document.getElementById('avg-rating');
                if (reviewsContainer) {
                    if (reviews.length > 0) {
                        const totalRating = reviews.reduce((acc, review) => acc + review.rating, 0);
                        const avgRating = (totalRating / reviews.length).toFixed(1);
                        avgRatingEl.innerHTML = `<span class="text-primary">${'★'.repeat(Math.round(avgRating))}${'☆'.repeat(5 - Math.round(avgRating))}</span><span class="ml-2 text-white">${avgRating} de 5 (${reviews.length} avaliações)</span>`;
                        reviewsContainer.innerHTML = reviews.map(review => `
                            <div class="bg-gray-800/50 p-4 rounded-lg">
                                <div class="flex items-center mb-1">
                                    <span class="text-primary">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</span>
                                </div>
                                <p class="text-gray-300">${review.comment || '<i>Sem comentário.</i>'}</p>
                            </div>`).join('');
                    } else {
                        avgRatingEl.innerHTML = `<span class="text-gray-500">Ainda não avaliado</span>`;
                        reviewsContainer.innerHTML = '<p class="text-gray-500">Seja o primeiro a avaliar este grupo!</p>';
                    }
                }
            });
            document.getElementById('review-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const rating = e.target.rating.value;
                const comment = e.target.comment.value.trim();
                if (!rating) {
                    showToast("Por favor, selecione uma avaliação de estrelas.", 'star', true);
                    return;
                }
                try {
                    await addDoc(collection(db, `groups/${group.id}/reviews`), {
                        rating: Number(rating),
                        comment: comment,
                        timestamp: serverTimestamp()
                    });
                    showToast("Avaliação enviada com sucesso!", 'check_circle');
                    e.target.reset();
                } catch {
                    showToast("Erro ao enviar avaliação.", 'error', true);
                }
            });
        };
        const renderAddGroupPage = (group = null) => {
            const isEditing = !!group;
            views.add.dataset.editingId = group ? group.id : '';
            const predefinedCategories = ['Amizade', 'Animes', 'Figurinhas', 'Filmes e Séries', 'Frases', 'Games', 'Humor', 'Notícias', 'Tecnologia', 'Vendas'];
            views.add.innerHTML = `
                <div class="max-w-2xl mx-auto bg-surface-dark/80 backdrop-blur-md p-4 sm:p-8 rounded-2xl border border-gray-700">
                    <div class="flex items-center justify-between mb-6"><h2 class="text-2xl sm:text-3xl font-bold text-white">${isEditing ? 'Editar Grupo' : 'Adicionar Novo Grupo'}</h2><a href="#home" class="nav-link text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></a></div>
                    <form id="group-form" class="space-y-6">
                        <input type="hidden" id="group-id" value="${group?.id || ''}">
                        <input type="hidden" id="existing-icon-url" value="${group?.iconUrl || ''}">
                        <div><label for="icon-upload" class="block text-sm font-medium text-gray-300 mb-2">Ícone do Grupo</label><div class="flex items-center gap-4"><img id="icon-preview" src="${group?.iconUrl || 'https://placehold.co/128x128/1A1A1A/444?text=Icon'}" alt="Preview" class="w-24 h-24 object-cover rounded-lg border border-gray-700"><label for="icon-upload" class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">Escolher Arquivo</label><input type="file" id="icon-upload" class="hidden" accept="image/png, image/jpeg, image/webp"></div><div id="upload-progress-container" class="w-full bg-gray-700 rounded-full h-2.5 mt-3 hidden"><div id="upload-progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div></div></div>
                        <div><label class="block text-sm font-medium text-gray-300 mb-2">Plataforma</label><div class="flex gap-4">
                            <input type="radio" id="p-telegram" name="platform" value="Telegram" class="hidden peer/telegram" ${!group || group.platform === 'Telegram' ? 'checked' : ''}><label for="p-telegram" class="flex-1 cursor-pointer flex items-center justify-center gap-3 p-4 rounded-lg border-2 border-gray-600 peer-checked/telegram:border-primary peer-checked/telegram:bg-primary/10 transition-all"><i class="fa-brands fa-telegram text-2xl text-cyan-400"></i><span class="font-bold text-white">Telegram</span></label>
                            <input type="radio" id="p-whatsapp" name="platform" value="WhatsApp" class="hidden peer/whatsapp" ${group?.platform === 'WhatsApp' ? 'checked' : ''}><label for="p-whatsapp" class="flex-1 cursor-pointer flex items-center justify-center gap-3 p-4 rounded-lg border-2 border-gray-600 peer-checked/whatsapp:border-green-500 peer-checked/whatsapp:bg-green-500/10 transition-all"><i class="fa-brands fa-whatsapp text-2xl text-green-500"></i><span class="font-bold text-white">WhatsApp</span></label>
                        </div></div>
                        <div><label for="title" class="block text-sm font-medium text-gray-300 mb-2">Título do Grupo</label><input type="text" id="title" value="${group?.title || ''}" required class="w-full bg-background-dark border-gray-700 rounded-lg focus:ring-primary focus:border-primary"></div>
                        <div><label for="description" class="block text-sm font-medium text-gray-300 mb-2">Descrição Curta</label><textarea id="description" rows="3" required class="w-full bg-background-dark border-gray-700 rounded-lg focus:ring-primary focus:border-primary">${group?.description || ''}</textarea></div>
                        <div><label for="link" class="block text-sm font-medium text-gray-300 mb-2">Link de Convite</label><input type="url" id="link" value="${group?.link || ''}" required class="w-full bg-background-dark border-gray-700 rounded-lg focus:ring-primary focus:border-primary"></div>
                        <div><label for="category" class="block text-sm font-medium text-gray-300 mb-2">Categoria</label><input type="text" id="category" value="${group?.category || ''}" list="category-list" required placeholder="Digite ou escolha uma categoria" class="w-full bg-background-dark border-gray-700 rounded-lg focus:ring-primary focus:border-primary"><datalist id="category-list">${predefinedCategories.map(c => `<option value="${c}">`).join('')}</datalist></div>
                        ${isAdmin ? `<div class="space-y-4 pt-4 border-t border-gray-700"><div class="flex items-center"><input id="featured" type="checkbox" ${group?.featured ? 'checked' : ''} class="h-4 w-4 rounded border-gray-600 bg-gray-800 text-primary focus:ring-primary"><label for="featured" class="ml-2 block text-sm text-gray-200">Marcar como Destaque</label></div><div><label for="longDescription" class="block text-sm font-medium text-gray-300 mb-1">Descrição Longa (Destaques)</label><textarea id="longDescription" rows="5" class="w-full bg-background-dark border-gray-700 rounded-lg focus:ring-primary focus:border-primary">${group?.longDescription || ''}</textarea></div></div>` : ''}
                        <div class="pt-2"><button type="submit" id="form-submit-btn" class="w-full flex items-center justify-center gap-2 bg-primary text-black font-bold py-3 px-6 rounded-lg hover:bg-primary-dark transition-transform hover:scale-105 text-lg disabled:opacity-50 disabled:cursor-wait"><span id="form-submit-icon" class="material-symbols-outlined">publish</span><span id="form-submit-text">Publicar Grupo</span></button></div>
                    </form>
                </div>`;
            addFormEventListeners();
        };

        const addFormEventListeners = () => {
            const form = document.getElementById('group-form');
            if(!form) return;
            form.addEventListener('submit', handleFormSubmit);
            const iconUploadInput = document.getElementById('icon-upload');
            const iconPreview = document.getElementById('icon-preview');
            iconUploadInput.addEventListener('change', () => {
                const file = iconUploadInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { iconPreview.src = e.target.result; };
                    reader.readAsDataURL(file);
                }
            });
        };

        const filterAndRenderGroups = () => {
            const homeView = views.home;
            if(!homeView.querySelector('#all-groups-container')) return;
            const searchLower = currentFilter.search.toLowerCase();
            const filtered = allGroups.filter(g => {
                const inCategory = currentFilter.category === 'Todos' || g.category === currentFilter.category;
                const inSearch = !searchLower || g.title.toLowerCase().includes(searchLower) || g.description.toLowerCase().includes(searchLower) || g.category.toLowerCase().includes(searchLower);
                return inCategory && inSearch;
            });
            const featuredContainer = homeView.querySelector('#featured-groups-container');
            const allContainer = homeView.querySelector('#all-groups-container');
            const noResults = homeView.querySelector('#no-results');
            featuredContainer.innerHTML = filtered.filter(g => g.featured).map(g => createGroupCardHTML(g, true)).join('') || '<p class="text-gray-500 col-span-full">Nenhum grupo em destaque para este filtro.</p>';
            allContainer.innerHTML = filtered.filter(g => !g.featured).map(g => createGroupCardHTML(g, false)).join('');
            noResults.classList.toggle('hidden', filtered.length > 0);
            if (isAdmin) addAdminEventListeners();
        };

        const renderCategoryFilters = () => {
             const container = views.home.querySelector('#category-filters-container');
             if(!container) return;
             const categories = ['Todos', ...new Set(allGroups.map(g => g.category).filter(Boolean).sort())];
             container.innerHTML = categories.map(cat => `<button data-category="${cat}" class="category-btn text-sm font-semibold px-4 py-2 rounded-full transition-colors duration-300 ${cat === currentFilter.category ? 'bg-primary text-black' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}">${cat}</button>`).join('');
             container.querySelectorAll('.category-btn').forEach(btn => btn.addEventListener('click', (e) => {
                 currentFilter.category = e.target.dataset.category;
                 filterAndRenderGroups();
                 renderCategoryFilters();
             }));
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            processingOverlay.classList.add('flex');
            processingOverlay.classList.remove('hidden');
            
            const file = form.querySelector('#icon-upload').files[0];
            let iconUrl = form.querySelector('#existing-icon-url').value;
            
            const saveGroupToFirestore = async (finalIconUrl) => {
                const id = form.querySelector('#group-id').value;
                const groupData = {
                    platform: form.querySelector('[name="platform"]:checked').value,
                    title: form.querySelector('#title').value,
                    iconUrl: finalIconUrl,
                    description: form.querySelector('#description').value,
                    link: form.querySelector('#link').value,
                    category: form.querySelector('#category').value,
                    createdAt: serverTimestamp(),
                };
                if (isAdmin) {
                    groupData.featured = form.querySelector('#featured')?.checked || false;
                    groupData.longDescription = form.querySelector('#longDescription')?.value || '';
                }
                try {
                    if (id) {
                        await setDoc(doc(db, "groups", id), groupData, { merge: true });
                        showToast("Grupo atualizado com sucesso!", 'update');
                    } else {
                        await addDoc(collection(db, "groups"), groupData);
                        showToast("Grupo enviado para a comunidade!", 'check_circle');
                    }
                    window.location.hash = '#home';
                } catch (error) { showToast("Erro ao salvar o grupo.", 'error', true); }
                finally {
                    processingOverlay.classList.add('hidden');
                    processingOverlay.classList.remove('flex');
                }
            };

            if (file) {
                const storageRef = ref(storage, `group-icons/${Date.now()}_${file.name}`);
                const uploadTask = uploadBytesResumable(storageRef, file);
                uploadTask.on('state_changed', 
                    null, 
                    (error) => { 
                        showToast("Erro no upload do ícone.", 'cloud_off', true); 
                        processingOverlay.classList.add('hidden');
                        processingOverlay.classList.remove('flex');
                    }, 
                    async () => {
                        iconUrl = await getDownloadURL(uploadTask.snapshot.ref);
                        await saveGroupToFirestore(iconUrl);
                    }
                );
            } else {
                await saveGroupToFirestore(iconUrl);
            }
        };

        const checkAdminStatus = async () => {
            const keyFromUrl = new URLSearchParams(window.location.search).get('admin_key');
            if (!keyFromUrl) return;
            try {
                const adminConfigDoc = await getDoc(doc(db, "config", "admin"));
                if (adminConfigDoc.exists() && adminConfigDoc.data().secretKey === keyFromUrl) {
                    isAdmin = true;
                    showToast("Modo Admin ativado!", 'shield_person');
                } else { showToast("Chave de admin inválida.", 'gpp_bad', true); }
            } catch (error) { console.error("Could not verify admin status:", error); }
        };

        const adminControls = (id) => `<a href="#edit-group/${id}" class="nav-link edit-btn bg-blue-500/80 hover:bg-blue-500 text-white p-2 rounded-full" data-id="${id}"><span class="material-symbols-outlined text-base">edit</span></a><button class="delete-btn bg-red-500/80 hover:bg-red-500 text-white p-2 rounded-full" data-id="${id}"><span class="material-symbols-outlined text-base">delete</span></button>`;
        const addAdminEventListeners = () => {
            document.querySelectorAll('.delete-btn').forEach(btn => {
                if (btn.dataset.listener) return;
                btn.dataset.listener = true;
                btn.addEventListener('click', async (e) => {
                    e.preventDefault(); e.stopPropagation();
                    if (confirm('Tem certeza? Esta ação é irreversível.')) {
                        try { await deleteDoc(doc(db, "groups", btn.dataset.id)); showToast("Grupo excluído.", 'delete_forever'); }
                        catch(err) { showToast("Erro ao excluir.", 'error', true); }
                    }
                });
            });
        };
        
        const handleNavigation = () => {
            const hash = window.location.hash || '#home';
            switchView(hash);
        };
        
        // --- SOLUÇÃO DE CARREGAMENTO ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Renderiza a estrutura da Home Page e os esqueletos IMEDIATAMENTE.
            renderHomePage(); 
            renderSkeletons(views.home.querySelector('#featured-groups-container'), 3);
            renderSkeletons(views.home.querySelector('#all-groups-container'), 8);
            
            // 2. Mostra a página inicial (com esqueletos) IMEDIATAMENTE.
            handleNavigation(); 
            
            // 3. Verifica o status de admin em segundo plano.
            await checkAdminStatus();
            
            // 4. Inicia o listener do Firebase para buscar os dados.
            onSnapshot(query(collection(db, "groups"), orderBy("createdAt", "desc")), (snapshot) => {
                allGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // 5. ATUALIZA a view atual com os dados reais assim que chegam.
                handleNavigation(); 
            }, (error) => showToast("Erro de conexão.", 'signal_wifi_off', true));
            
            // 6. Adiciona o listener para navegação futura.
            window.addEventListener('hashchange', handleNavigation);
        });
    </script>
</body>
</html>

